<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Face Recognition</title>
  <link rel="shortcut icon" href="img/favicon.ico" />
  <link href="https://fonts.googleapis.com/css?family=Karla&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/bootstrap.min.css" />
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="js/facialRecognitionAPI.js"></script>
  <script src="js/filter.js"></script>
</head>
<body>
  <nav class="navbar">
    <input type="checkbox" id="nav-check" />
    <div class="nav-header">
      <div class="nav-title">
        <a href="#" class="terrenial-logo">
          <img src="img/favicon.ico" style="width: 14pt; display: inline; position: relative; bottom: -2.9px;" />
          terrennial
        </a>
      </div>
    </div>
    <div class="nav-btn">
      <label for="nav-check">
        <svg id="svg-close" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 53 53">
          <defs>
            <style>
              .cls-1 {
                fill: none;
                stroke: #231f20;
                stroke-linecap: round;
                stroke-miterlimit: 10;
                stroke-width: 3px;
              }
            </style>
          </defs>
          <title>iconAsset 2</title>
          <g id="Layer_2" data-name="Layer 2">
            <g id="Layer_1-2" data-name="Layer 1">
              <line class="cls-1" x1="1.5" y1="51.5" x2="51.5" y2="1.5" />
              <line class="cls-1" x1="1.5" y1="1.5" x2="51.5" y2="51.5" />
            </g>
          </g>
        </svg>
        <svg id="svg-burger" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 96.72 53.16">
          <defs>
            <style>
              .cls-1 {
                fill: none;
                stroke: #fff;
                stroke-linecap: round;
                stroke-miterlimit: 10;
                stroke-width: 3.16px;
              }
            </style>
          </defs>
          <g id="Layer_2" data-name="Layer 2">
            <g id="Layer_1-2" data-name="Layer 1">
              <line class="cls-1" x1="1.58" y1="1.58" x2="95.14" y2="1.58" />
              <line class="cls-1" x1="1.58" y1="51.58" x2="95.14" y2="51.58" />
              <line class="cls-1" x1="1.58" y1="26.18" x2="95.14" y2="26.18" />
            </g>
          </g>
        </svg>
      </label>
    </div>
    <div class="nav-links">
      <a href="#">Home</a>
      <a class="is-lightmode" href="archive.html">Archive</a>
      <a class="is-darkmode" href="archive-dark.html">Archive</a>
      <a class="is-lightmode" href="about-us.html">About Us</a>
      <a class="is-darkmode" href="about-us-dark.html">About Us</a>
    </div>
  </nav>

  <div class="theme-container">
    <!-- Wrapper -->
    <div class="wrapper paper-background">
        <video id="myVideo" width="100%" height="100%"></video>
        <canvas id="canvas" class="container" width="100%" height="100%" style="width:1020px; display:table;">
        <canvas id="videoCanvas" width="100%" height="100%">
          </canvas>
      </canvas>
    </div>
  </div>

  <script>
    var logo = document.createElement("img");
    logo.src =
      "https://raw.githubusercontent.com/shikai93/FRAImageRecognition/master/logo.png";
    logo.crossOrigin = "anonymous";
    var video = document.getElementById("myVideo");
    var canvas = document.getElementById("canvas");
    var videoCanvas = document.getElementById("videoCanvas");
    var ctx = canvas.getContext("2d");
    var img;
    var filter;

    // test function to draw bounding rectangle
    function drawRectangle(rectangle, color) {
      var canvas = document.getElementById("canvas");
      var ctx = canvas.getContext("2d");
      ctx.beginPath();
      ctx.rect(
        rectangle.left,
        rectangle.top,
        rectangle.width,
        rectangle.height
      );
      ctx.lineWidth = 2;
      ctx.strokeStyle = color;
      ctx.stroke();
    }

    window.onload = function () {
      // set video src to be from webcam
      if (navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices
          .getUserMedia({ video: true })
          .then(function (stream) {
            video.srcObject = stream;
            video.onplaying = function () {
              videoCanvas.width = $("#container").width();
              videoCanvas.height = $("#container").height();
              canvas.width = $("#container").width();
              canvas.height = $("#container").height();
              $(".overlay").height($(".container").height());
            };
          });
      }

      // setup tracking of video to send data to API at 500ms interval
      trackVideo(videoCanvas, video, rects => {
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        rects.forEach((rect, idx) => {
          // drawRectangle(rect,"red")
          filter = new Filter(
            "wigyellow",
            rect.left,
            rect.top,
            rect.width,
            rect.height
          );
          img = filter.generate();
          img.crossOrigin = "anonymous";
          img.onload = function () {
            ctx.drawImage(img, filter.x, filter.y, filter.w, filter.h);
          };
        });
      });
    };

    // for downloading of picture
    var link = document.getElementById("download");
    link.addEventListener(
      "click",
      function () {
        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        if (filter !== undefined && img !== undefined) {
          ctx.drawImage(img, filter.x, filter.y, filter.w, filter.h);
        }
        var logoWidth = (642 / 376) * 120;
        var logoHeight = 120;
        ctx.drawImage(
          logo,
          canvas.width - logoWidth,
          canvas.height - logoHeight,
          logoWidth,
          logoHeight
        );
        link.setAttribute("href", canvas.toDataURL());
        link.setAttribute("download", "mypic.png");
      },
      false
    );
  </script>
</body>

</html>